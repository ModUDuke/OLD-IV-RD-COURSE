--- 
title       : "Introduction to Instrumental Variables"
description : "This chapter will introduce you to instrumental variables (IV) analysis"
 
  
--- type:VideoExercise lang:r aspect_ratio:62.5 xp:50 skills:1 key:9c7273586e
## The Logic of Instrumental Variables
*** =video_link
//player.vimeo.com/video/219558904

--- type:VideoExercise lang:r aspect_ratio:62.5 xp:50 skills:1 key:8a1c462927
## Visual Logic of Instrumental Variables
*** =video_link
//player.vimeo.com/video/219559011

--- type:MultipleChoiceExercise lang:r xp:50 skills:1 key:8c410956e7
## Assumptions of instrumental variables
Which of the following is *not* a key identifying assumption/condition of instrumental variables?

*** =instructions
- Instrument has a causal effect on the outcome
- Instrument is randomly assigned
- Instrument has a causal effect on the treatment
- Instrument is correlated with the outcome
*** =sct
```{r}
msg1 = "Correct! The instrument cannot have a causal effect on the outcome."
msg2 = "The instrument must be randomly assigned. Try again"
msg3 = "The instrument must have a causal effect on the treatment. Try again"
msg4 = "The instrument needs to be correlated with the outcome. Try again"
test_mc(correct = 1, feedback_msgs = c(msg1,msg2,msg3,msg4))
```

--- type:VideoExercise lang:r aspect_ratio:62.5 xp:50 skills:1 key:953b93e528
## Instrumental Variables in Action: Education and Wages (graphs)
*** =video_link
//player.vimeo.com/video/219559159

--- type:MultipleChoiceExercise lang:r xp:50 skills:1 key:16cf760443
## Correlation and causation in instrumental variables
True or False: If you see that there is a zero correlation between the treatment variable and the outcome variable, then the treatment cannot have a causal effect on outcomes---there must be correlation between those two variables if we are to have any hope of using instrumental variables to learn about causality.

*** =instructions
- True
- False
*** =sct
```{r}
msg1 = "Try again"
msg2 = "Correct! The amount or sign of correlation between treatments and outcomes is completely irrelevant for instrumental variables analysis. That is because we are considering the case where treatments are *not* randomly assigned, so we know that correlation (or the lack thereof) does not imply causation (or the lack thereof). For instrumental variables analysis, all the assumptions are about how the instrument itself relates to the other variables."
test_mc(correct = 2, feedback_msgs = c(msg1,msg2))
```

--- type:VideoExercise lang:r aspect_ratio:62.5 xp:50 skills:1 key:116a9fd6fa
## Instrumental Variables in Action: Education and Wages (tables)
*** =video_link
//player.vimeo.com/video/219559305


--- type:VideoExercise lang:r aspect_ratio:62.5 xp:50 skills:1 key:3ae8d65d96
## Some Instrumental Variables Terminology
*** =video_link
//player.vimeo.com/video/219565557


--- type:MultipleChoiceExercise lang:r xp:50 skills:1 key:5ad3dddd73
## Instrumental variables in practice
Suppose you have data on where students live once they graduate from college. You want to know the causal effect of living in a rural versus urban area on their wages. So you categorize locations as either urban or rural, giving you a binary treatment variable. What kind of variation is in that variable and why?

*** =instructions
- Exogenous
- Endogenous
- Both
*** =sct
```{r}
msg1 = "Not quite. Try again"
msg2 = "Not quite. Try again"
msg3 = "Correct! Locations are not exogenously determined because people choose where they want to live. If their choices are related to some other unobserved variables (like if people who desire more money choose to live in urban areas), then this produces endogenous variation. The reason it is likely both is that there might be other reasons that affect people's choice of where to live, like perhaps where their family is from, which might be unrelated to any variables that affect how much someone earns."
test_mc(correct = 3, feedback_msgs = c(msg1,msg2,msg3))
```

--- type:VideoExercise lang:r aspect_ratio:62.5 xp:50 skills:1 key:b70179796d
## The Three Instrumental Variables Assumptions
*** =video_link
//player.vimeo.com/video/219559447


--- type:MultipleChoiceExercise lang:r xp:50 skills:1 key:f9981cd29c
## Logical arguments about instrumental variables
Let's say that you have data on the impact of bike riding on child happiness, and you want to use the brand of bicycle as your instrument. What's the best argument that the brand of bike does not affect child happiness directly?

*** =instructions
- Kids don't have brand awareness like adults do
- Once they are on the bike, the brand doesn't matter
- Bike brands may be sized differently, but kids always adjust as needed
- Bike brands differ mostly in color patterns, and kids' preferences cancel each other out
*** =sct
```{r}
msg1 = "Correct! This is the best argument because, if kids are very brand aware, then simply owning a specific brand may make them very happy, independently of whether they actually ride the bike or not."
msg2 = "Not quite. Try again"
msg3 = "Not quite. Try again"
msg4 = "Not quite. Try again"
test_mc(correct = 1, feedback_msgs = c(msg1,msg2,msg3,msg4))
```


--- type:NormalExercise lang:r xp:100 skills:1 key:
## Practice using instrumental variables: CreditCo
In the experiments course, you assessed the validity of a natural experiment using data from CreditCo. Let's revisit that analysis, framing it in the logic of instrumental variables.

As you may recall, CreditCo sent out offers in the mail to increase their customers' credit limits. We are worried that the customers who took up the offer might not have randomly done so, which causes an endogeneity problem. We proposed to solve this problem by using the weather on the day the credit offers were delivered as an instrument for treatment. 

Included on the workspace is a data set from CreditCo. The data are a sample of CreditCo customers who were offered the credit limit increase. We will focus on the variable `rainy`, which we will use as an instrument for `opt_in`, which we suspect is endogenous to our outcomes of interest.

*** =instructions
- Using a linear regression, test whether rain satisfies the relevance assumption.
- What is the sign of the correlation between rain and opt-in?

*** =hint
- Remember to be aware of selecting the correct subsample

*** =pre_exercise_code
```{r}
  set.seed(1)
  n             <- 9e5
  frac_treated  <- .5
  frac_female   <- .5656
  frac_white    <- .688

# Initialize dataframe
  CreditCo <- as.data.frame(matrix(0, ncol=11,nrow=n))
  colnames(CreditCo) <- c("id","offered","opt_in","FICO","age","female","race_white","default_pre","default_post","balance_pre","balance_post")

# Simulate baseline data
  CreditCo$id         <- seq(1,n,1)
  CreditCo$offered    <- as.integer(runif(n)<frac_treated)
  CreditCo$opt_in     <- rep.int(0,n)
  CreditCo$FICO       <- rnorm(n, mean=736, sd=300)
  CreditCo$age        <- sample(18:55, n, replace=T)
  CreditCo$female     <- as.integer(runif(n)<frac_female)
  CreditCo$race_white <- as.integer(runif(n)<frac_white)

# make FICO score intelligible
  CreditCo$FICO[CreditCo$FICO>850] <- 850
  CreditCo$FICO[CreditCo$FICO<300] <- 300
  CreditCo$FICO                    <- round(CreditCo$FICO)

# simulate pre-experiment default rate
  draw <- runif(n)
  xb   <- -1.82-0.2*CreditCo$FICO/100+.046*(CreditCo$FICO^2)/10000-5.1*CreditCo$female-7*CreditCo$race_white
  p    <- exp(xb)/(1+exp(xb))
  CreditCo$default_pre <- as.integer(draw<p)

# simulate pre-experiment balance level
  draw <- rnorm(n, mean=0, sd=0.5)
  CreditCo$balance_pre <- 8.5-0.2*CreditCo$FICO/100+.046*(CreditCo$FICO^2)/10000-0.15*CreditCo$female-0.85*CreditCo$race_white + draw
  CreditCo$balance_pre <- exp(CreditCo$balance_pre)

# Simulate opt-in behavior based on weather
  draw <- runif(n)
  draw2 <- runif(n)
  CreditCo$rainy <- draw>0.5
  xb   <- 1.5-3*CreditCo$rainy+.2*CreditCo$female
  p    <- exp(xb)/(1+exp(xb))
  CreditCo$opt_in[CreditCo$offered==1] <- as.integer(draw2[CreditCo$offered==1]<p[CreditCo$offered==1])

# Simulate post outcomes
  draw <- runif(n)
  xb   <- -1.82-0.2*CreditCo$FICO/100+.046*(CreditCo$FICO^2)/10000-5.1*CreditCo$female-7*CreditCo$race_white+4*CreditCo$offered*CreditCo$opt_in
  p    <- exp(xb)/(1+exp(xb))
  CreditCo$default_post <- as.integer(draw<p)

# balance
  draw <- rnorm(n, mean=0, sd=0.5)
  CreditCo$balance_post <- 8.5-0.2*CreditCo$FICO/100+.046*(CreditCo$FICO^2)/10000-0.15*CreditCo$female-0.85*CreditCo$race_white + 1*CreditCo$offered*CreditCo$opt_in + draw
  CreditCo$balance_post <- exp(CreditCo$balance_post)

# Remove elements and variables from environment
  rm(draw,frac_female,frac_treated,frac_white,n,p,xb)
  CreditCo <- CreditCo[CreditCo$offered==1,c("id","opt_in","FICO","female","race_white","default_pre","default_post","balance_pre","balance_post","rainy")]
```

*** =sample_code
```{r}
# The dataset `CreditCo` is available in your workspace

# Question 1: Using a linear regression, compute the correlation between rain and opt-in status.
#---- Question 1-------------------------------------#
    Solution1<-lm( ~ ,data=CreditCo)
#----------------------------------------------------#

# Question 2: What is the p-value associated with the t-test on the coefficient of rain?
#---- Question 2-------------------------------------#
    Solution2<-summary(Solution1$coefficients[2,4])
#----------------------------------------------------#

# Question 3: What is the sign of the correlation between rain and opt-in?
#---- Question 3-------------------------------------#
    Solution3<-sign(Solution1$coefficients[2])
#----------------------------------------------------#

```

*** =solution
```{r}
Solution1 <- lm(opt_in~rainy,data=CreditCo)
Solution2 <- summary(Solution1$coefficients[2,4])
Solution3 <- sign(Solution1$coefficients[2])
```

*** =sct
```{r}
test_object("Solution1")
test_object("Solution2")
success_msg("Good work!")
```





--- type:VideoExercise lang:r aspect_ratio:62.5 xp:50 skills:1 key:9cc4cfa847
## Refutability and nonrefutability of the instrumental variables assumptions
*** =video_link
//player.vimeo.com/video/219559377


--- type:MultipleChoiceExercise lang:r xp:50 skills:1 key:db21106fcb
## Questioning the validity of instrumental variables results
Many researchers have found the distance-to-college instrument questionable. What do you think is the most plausible reason?

*** =instructions
- Researchers think the relevance assumption does not hold---whether you live close to a college or not doesn't actually affect whether you go to college or not.
- Researchers think the exclusion restriction does not hold---employers are willing to pay people more money if students went to high school in a town that was close to a college.
- Researchers think the exogeneity assumption does not hold---there are unobserved variables like ability which are correlated with distance-to-college and which affect how much income you'll make.
*** =sct
```{r}
msg1 = "Not quite. Remember: relevance is refutable, so people don't usually complain about this because it can be checked in the data. Try again"
msg2 = "This is not the most common complaint. Try again"
msg3 = "Correct! This is the most common complaint."
test_mc(correct = 1, feedback_msgs = c(msg1,msg2,msg3))
```

--- type:VideoExercise lang:r aspect_ratio:62.5 xp:50 skills:1 key:88c5d08f7e
## Indirect Inference
*** =video_link
//player.vimeo.com/video/219559540


--- type:VideoExercise lang:r aspect_ratio:62.5 xp:50 skills:1 key:91d63315da
## Two Stage Least Squares (2SLS)
*** =video_link
//player.vimeo.com/video/219559617
