--- 
title       : "Practice with Instrumental Variables"
description : "This chapter will allow you to practice instrumental variables (IV) analysis"
 

--- type:VideoExercise lang:r aspect_ratio:62.5 xp:50 skills:1 key:b70179796d
## The Three Instrumental Variables Assumptions
*** =video_link
//player.vimeo.com/video/219559447


--- type:MultipleChoiceExercise lang:r xp:50 skills:1 key:76ab8a34c9
## Using IV When There is Measurement Error
You're doing some research and plan on using an instrumental variables strategy to help with any noncompliance. But your instrument was hard to measure perfectly, so you think its values have some measurement error. Two of the following statements are valid for an IV analysis, but which one would violate the assumptions of IV analysis and make our results invalid?

*** =instructions
- The instrument's measurement error is independent of the values for the treatment and outcome variables
- The instrument's measurement error is independent of the values of the treatment variable, but not for the outcome variable
- The instrument's measurement error is independent of the values from the outcome variable, but not for the treatment variable

*** =sct
```{r}
msg1 = "This is perfectly fine with IV analysis. If the measurement error is not affecting the measurement of the treatment and outcome variables, then we're safe. We are looking for the option that would violate the IV assumptions, so try again."
msg2 = "Correct! This would break our IV analysis, because it would mean that the instrument has some direct effect on the values of theoutcome variable by itself, but to use IV correctly, we need the instrument to only indirectly act on the outcome via the treatment variable."
msg3 = "This is perfectly fine with IV analysis. We expect the instrument to have a causal effect on the treatment variable, so it would make sense that the measurement error would show up in the value of our treatment variable. But we are looking for the option that would violate the IV assumptions, so try again."
test_mc(correct = 2, feedback_msgs = c(msg1,msg2,msg3))
```

--- type:MultipleChoiceExercise lang:r xp:50 skills:1 key:f9981cd29c
## Logical Arguments About Instrumental Variables

Let's say that you work for the city government of a town that has been rated as having the least happy children in the country. Your town also wants to increase the number of bike lanes on city streets. As a creative data analyst, you think that bike lanes may encourage families to exercise together, and exercising as a family may change the unhappy kids in your town into happy kids. You get your hands on a national dataset that has statistics on bike lanes, family exercise, and child happiness from many cities. You think that you can use bike lanes as an instrumental variable to see if family exercise has an effect on child happiness. Your basic argument is that bike lanes cause families to exercise together, and family exercise is correlated with child happiness, so bike lanes are an instrument for the effect of family exercise on child happiness. What is your best argument that the instrument does not have a direct causal effect on the outcome variable? 
  
  *** =instructions
- Kids are not made happier from the painted lines on the road
- All kids are equally happy when they are on a bike, whether alone or with their family
- Traffic safety with bike lanes always varies, but kids adjust as needed
- Some kids are happier to ride in bike lanes and happier to bike offroad, but those preferences cancel each other out

*** =sct
```{r}
msg1 = "Correct! This is the best argument because, if kids only bike when there are bike lanes, then this argument would suddenly become a very weak one, because simply painting new lines on a road would make kids very happy, independently of whether they actually ride a bike or not."
msg2 = "This might be true, but that is directed more at whether the treatment (riding with a family) affects the outcome (child happiness), not the instrument on the outcome like the question asks. Try again"
msg3 = "Kids may need to feel safe to be happy, but we aren't trying to use a 'feeling of safety' as an instrument. Try again"
msg4 = "If this were true, it sounds like the instrument would be uncorrelated with our outcome, which would make our IV analysis invalid, because we need the instrument to be correlated to the outcome exlcusively by the causal effect of the treatment. So try again."
test_mc(correct = 1, feedback_msgs = c(msg1,msg2,msg3,msg4))
```


--- type:NormalExercise lang:r xp:100 skills:1 key:80186483d8
## Practice Using Instrumental Variables: CreditCo
If you took our Experiments course, you assessed the validity of a natural experiment using data from CreditCo. Let's revisit that analysis, framing it in the logic of instrumental variables.

As you may recall, CreditCo sent out offers in the mail to increase their customers' credit limits. We are worried that the customers who took up the offer might not have randomly done so, which causes an endogeneity problem. We proposed to solve this problem by using the rainy weather on the day the credit offers were delivered as an instrument for treatment. 

Included on the workspace is a dataset from CreditCo. The data are a sample of CreditCo customers who were offered the credit limit increase. We will focus on the variable `rainy`, which we will use as an instrument for `opt_in`, which we suspect is endogenous to our outcomes of interest.

*** =instructions
- 1) Using a linear regression, compute the correlation between opt-in and rain.
- 2) Test whether rain satisfies the relevance assumption (i.e. if its correlation with opt-in is significantly different from zero).
- 3) What is the sign of the correlation between rain and opt-in?

*** =hint
- Remember to be aware of selecting the correct subsample

*** =pre_exercise_code
```{r}
  set.seed(1)
  n             <- 9e5
  frac_treated  <- .5
  frac_female   <- .5656
  frac_white    <- .688

# Initialize dataframe
  CreditCo <- as.data.frame(matrix(0, ncol=11,nrow=n))
  colnames(CreditCo) <- c("id","offered","opt_in","FICO","age","female","race_white","default_pre","default_post","balance_pre","balance_post")

# Simulate baseline data
  CreditCo$id         <- seq(1,n,1)
  CreditCo$offered    <- as.integer(runif(n)<frac_treated)
  CreditCo$opt_in     <- rep.int(0,n)
  CreditCo$FICO       <- rnorm(n, mean=736, sd=300)
  CreditCo$age        <- sample(18:55, n, replace=T)
  CreditCo$female     <- as.integer(runif(n)<frac_female)
  CreditCo$race_white <- as.integer(runif(n)<frac_white)

# make FICO score intelligible
  CreditCo$FICO[CreditCo$FICO>850] <- 850
  CreditCo$FICO[CreditCo$FICO<300] <- 300
  CreditCo$FICO                    <- round(CreditCo$FICO)

# simulate pre-experiment default rate
  draw <- runif(n)
  xb   <- -1.82-0.2*CreditCo$FICO/100+.046*(CreditCo$FICO^2)/10000-5.1*CreditCo$female-7*CreditCo$race_white
  p    <- exp(xb)/(1+exp(xb))
  CreditCo$default_pre <- as.integer(draw<p)

# simulate pre-experiment balance level
  draw <- rnorm(n, mean=0, sd=0.5)
  CreditCo$balance_pre <- 8.5-0.2*CreditCo$FICO/100+.046*(CreditCo$FICO^2)/10000-0.15*CreditCo$female-0.85*CreditCo$race_white + draw
  CreditCo$balance_pre <- exp(CreditCo$balance_pre)

# Simulate opt-in behavior based on weather
  draw <- runif(n)
  draw2 <- runif(n)
  CreditCo$rainy <- draw>0.5
  xb   <- 1.5-3*CreditCo$rainy+.2*CreditCo$female
  p    <- exp(xb)/(1+exp(xb))
  CreditCo$opt_in[CreditCo$offered==1] <- as.integer(draw2[CreditCo$offered==1]<p[CreditCo$offered==1])

# Simulate post outcomes
  draw <- runif(n)
  xb   <- -1.82-0.2*CreditCo$FICO/100+.046*(CreditCo$FICO^2)/10000-5.1*CreditCo$female-7*CreditCo$race_white+4*CreditCo$offered*CreditCo$opt_in
  p    <- exp(xb)/(1+exp(xb))
  CreditCo$default_post <- as.integer(draw<p)

# balance
  draw <- rnorm(n, mean=0, sd=0.5)
  CreditCo$balance_post <- 8.5-0.2*CreditCo$FICO/100+.046*(CreditCo$FICO^2)/10000-0.15*CreditCo$female-0.85*CreditCo$race_white + 1*CreditCo$offered*CreditCo$opt_in + draw
  CreditCo$balance_post <- exp(CreditCo$balance_post)

# Remove elements and variables from environment
  rm(draw,frac_female,frac_treated,frac_white,n,p,xb)
  CreditCo <- CreditCo[CreditCo$offered==1,c("id","opt_in","FICO","female","race_white","default_pre","default_post","balance_pre","balance_post","rainy")]
```

*** =sample_code
```{r}
# The dataset `CreditCo` is available in your workspace.

# 1) First we need to determine whether our instrument satisfies the Relevance Assumption, and we'll start this process by looking to see if it has any correlation with our outcome variable. Using a linear regression, compute the correlation between rain and opt-in status.

    Solution1<-lm( ~ ,data=CreditCo)


# 2) If it does have a correlation, we need to make sure it's a statistically significant one. What is the p-value associated with the t-test on the coefficient of rain?

    Solution2<-summary(Solution1)$coefficients[2,4]


# 3) What is the sign of the correlation between rain and opt-in?

    Solution3<-sign(Solution1$coefficients[2])


```

*** =solution
```{r}
Solution1 <- lm(opt_in~rainy,data=CreditCo)
Solution2 <- summary(Solution1)$coefficients[2,4]
Solution3 <- sign(Solution1$coefficients[2])
```

*** =sct
```{r}
test_object("Solution1")
test_object("Solution2")
test_object("Solution3")
success_msg("Good work! Our instrument does seem to have a statistically significant negative correlation with our outcome variable. This is one important pillar that supports our argument that we can use the rainy weather as an instrument in this analysis. ")
```




--- type:VideoExercise lang:r aspect_ratio:62.5 xp:50 skills:1 key:9cc4cfa847
## Refutability and Nonrefutability of the Instrumental Variables Assumptions
*** =video_link
//player.vimeo.com/video/219559377


--- type:MultipleChoiceExercise lang:r xp:50 skills:1 key:db21106fcb
## Questioning the Validity of Instrumental Variables Results
Remember back to an earlier video, where we looked at the hyothetical question of whether going to college increases how much money you make, using the travel distance between home and the college as an instrumental variable. Researchers looking at this analysis will be worrying about the nonrefutable Exclusion Restriction and Exogeneity Assumption in this design. What do you think the most valid criticism would be?

*** =instructions
- Researchers think the Relevance Assumption does not hold: whether you live close to a college or not doesn't actually affect whether you go to college or not
- Researchers think the Exclusion Restriction does not hold: employers are willing to pay people more money if students went to high school in a town that was close to a college
- Researchers think the Exogeneity Assumption does not hold: there are unobserved variables, like ability, which are correlated with distance-to-college and which also affect how much income you'll make

*** =sct
```{r}
msg1 = "Not quite. Remember that relevance is refutable, so people don't usually complain about this because it can be checked in the data. Try again"
msg2 = "This is probably not the most common complaint, because it would take a long and complex argument to justify this as the single main reason why the IV analysis is invalid. Try again"
msg3 = "Correct! This would be the most common complaint, and it's a good one. Luckily, the example was theoretical!"
test_mc(correct = 3, feedback_msgs = c(msg1,msg2,msg3))
```

--- type:VideoExercise lang:r aspect_ratio:62.5 xp:50 skills:1 key:88c5d08f7e
## Indirect Inference
*** =video_link
//player.vimeo.com/video/219559540



--- type:NormalExercise lang:r xp:100 skills:1 key:721d6bc016
## Practice Computing Causal Effects Using Indirect Inference: CreditCo
Now let's repeat the previous CreditCo analysis, but now use indirect inference to compute the causal effect of opting in to a credit limit increase on one's credit balance.

The setting is the same as before. CreditCo sent out offers in the mail to increase their customers' credit limits. But we know that taking up the offer is not randomly determined. We proposed to solve this problem by using the whether it rained on the day the credit offers were delivered as an instrument for takeup. 

In this exercise, we will restrict our analysis to the set of customers who received the offer. We will use the method of indirect inference to estimate the causal effect of takeup on credit balance.

Included on the workspace is a data set from CreditCo. The data are a sample of CreditCo customers who were offered the credit limit increase. We will focus on the variable `rainy`, which we will use as an instrument for `opt_in`, which we suspect is endogenous to our outcomes of interest.

*** =instructions
- 1) Using a linear regression, compute the reduced-form effect (i.e. correlation between credit balance and rain)
- 2) Using a linear regression, compute the first-stage effect (i.e. correlation between opting in and rain)
- 3) Now compute the causal effect, which is equal to (reduced form)/(first stage)
- 4) Did opting in to the credit offer increase or decrease credit balances?

*** =hint
- Remember to be aware of selecting the correct subsample

*** =pre_exercise_code
```{r}
  set.seed(1)
  n             <- 9e5
  frac_treated  <- .5
  frac_female   <- .5656
  frac_white    <- .688

# Initialize dataframe
  CreditCo <- as.data.frame(matrix(0, ncol=11,nrow=n))
  colnames(CreditCo) <- c("id","offered","opt_in","FICO","age","female","race_white","default_pre","default_post","balance_pre","balance_post")

# Simulate baseline data
  CreditCo$id         <- seq(1,n,1)
  CreditCo$offered    <- as.integer(runif(n)<frac_treated)
  CreditCo$opt_in     <- rep.int(0,n)
  CreditCo$FICO       <- rnorm(n, mean=736, sd=300)
  CreditCo$age        <- sample(18:55, n, replace=T)
  CreditCo$female     <- as.integer(runif(n)<frac_female)
  CreditCo$race_white <- as.integer(runif(n)<frac_white)

# make FICO score intelligible
  CreditCo$FICO[CreditCo$FICO>850] <- 850
  CreditCo$FICO[CreditCo$FICO<300] <- 300
  CreditCo$FICO                    <- round(CreditCo$FICO)

# simulate pre-experiment default rate
  draw <- runif(n)
  xb   <- -1.82-0.2*CreditCo$FICO/100+.046*(CreditCo$FICO^2)/10000-5.1*CreditCo$female-7*CreditCo$race_white
  p    <- exp(xb)/(1+exp(xb))
  CreditCo$default_pre <- as.integer(draw<p)

# simulate pre-experiment balance level
  draw <- rnorm(n, mean=0, sd=0.5)
  CreditCo$balance_pre <- 8.5-0.2*CreditCo$FICO/100+.046*(CreditCo$FICO^2)/10000-0.15*CreditCo$female-0.85*CreditCo$race_white + draw
  CreditCo$balance_pre <- exp(CreditCo$balance_pre)

# Simulate opt-in behavior based on weather
  draw <- runif(n)
  draw2 <- runif(n)
  CreditCo$rainy <- draw>0.5
  xb   <- 1.5-3*CreditCo$rainy+.2*CreditCo$female
  p    <- exp(xb)/(1+exp(xb))
  CreditCo$opt_in[CreditCo$offered==1] <- as.integer(draw2[CreditCo$offered==1]<p[CreditCo$offered==1])

# Simulate post outcomes
  draw <- runif(n)
  xb   <- -1.82-0.2*CreditCo$FICO/100+.046*(CreditCo$FICO^2)/10000-5.1*CreditCo$female-7*CreditCo$race_white+4*CreditCo$offered*CreditCo$opt_in
  p    <- exp(xb)/(1+exp(xb))
  CreditCo$default_post <- as.integer(draw<p)

# balance
  draw <- rnorm(n, mean=0, sd=0.5)
  CreditCo$balance_post <- 8.5-0.2*CreditCo$FICO/100+.046*(CreditCo$FICO^2)/10000-0.15*CreditCo$female-0.85*CreditCo$race_white + 1*CreditCo$offered*CreditCo$opt_in + draw
  CreditCo$balance_post <- exp(CreditCo$balance_post)

# Remove elements and variables from environment
  rm(draw,frac_female,frac_treated,frac_white,n,p,xb)
  CreditCo <- CreditCo[CreditCo$offered==1,c("id","opt_in","balance_post","rainy")]
```

*** =sample_code
```{r}
# The dataset `CreditCo` is available in your workspace.

# 1) Using a linear regression, compute the reduced-form effect (i.e. correlation between `balance_post` and `rainy`).

    Solution1<-lm( ~ ,data=CreditCo)


# 2) Using a linear regression, compute the first-stage effect (i.e. correlation between `opt_in` and `rainy`)

    Solution2<-lm( ~ ,data=CreditCo)


# 3) Compute the causal effect, which is equal to (reduced form)/(first stage)

    Solution3<-Solution1$coefficients[2]/Solution2$coefficients[2]


# 4) Did opting in to the credit offer increase or decrease credit balances? (type "increased" if Solution3 is positive or "decreased" if Solution3 is negative)

    Solution4<-""


```

*** =solution
```{r}
Solution1 <- lm(balance_post~rainy,data=CreditCo)
Solution2 <- lm(opt_in~rainy,data=CreditCo)
Solution3 <- Solution1$coefficients[2]/Solution2$coefficients[2]
Solution4 <- "increased"
```

*** =sct
```{r}
test_object("Solution1")
test_object("Solution2")
test_object("Solution3")
test_object("Solution4")
success_msg("Good work!")
```


--- type:VideoExercise lang:r aspect_ratio:62.5 xp:50 skills:1 key:91d63315da
## Two Stage Least Squares (2SLS)
*** =video_link
//player.vimeo.com/video/219559617

